Metadata:
  AWS::ServerlessRepo::Application:
    Name: SolarWinds-Observability-Logs
    Description: Send CloudWatch Logs to OTEL Collector endpoint (otlp/GRPc)
    Author: SolarWinds
    SpdxLicenseId: MIT
    LicenseUrl: LICENSE.txt
    ReadmeUrl: README.md
    Labels: ['CloudWatch', 'Logs', 'AWS', 'Observability', 'OTEL']
    HomePageUrl: http://www.solarwinds.com
    # The SemanticVersion is retrieved from the Mappings section to centralize version management.
    # This avoids duplication and ensures consistency across the template.
    SemanticVersion: !FindInMap [ApplicationConfig, Version, Number]
    SourceCodeUrl: https://github.com/solarwinds/cloud-observability-integration/tree/master/aws/logs

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Send CloudWatch Logs to OTEL Collector endpoint (otlp/GRPc)

# Application version mapping for centralized version management.
# This mapping is part of the template and ensures consistency for version references.
# To update the application version, change the value here.
Mappings:
  ApplicationConfig:
    Version:
      Number: 0.0.14

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 60

Parameters:
  OtlpEndpoint:
    Type: String
    Default: otel.collector.na-01.cloud.solarwinds.com:443
  ApiToken:
    Type: String
    Default: ''
  VpcFlowLogGroupName:
    Type: String
    Default: ''

Resources:
  SendLogsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Metadata:
      BuildMethod: go1.x
    Properties:
      CodeUri: send-logs/
      Handler: bootstrap
      Runtime: provided.al2023
      Architectures:
        - x86_64
      Tracing: Active # https://docs.aws.amazon.com/lambda/latest/dg/lambda-x-ray.html
      Environment:
        Variables:
          USE_ENCRYPTION: "no"
          OTLP_ENDPOINT: !Sub '${OtlpEndpoint}'
          API_TOKEN: !Sub '${ApiToken}'
          VPC_LOG_GROUP_NAME: !Sub '${VpcFlowLogGroupName}'
          LOG_LEVEL: "INFO"
          VPC_DEBUG_INTERVAL: "100"
      Tags:
        SWIVersion: !FindInMap [ApplicationConfig, Version, Number]
        SWIVpcLogGroup: !Ref VpcFlowLogGroupName

Outputs:
  SendLogsFunction:
    Description: "SolarWinds Observability Logs function ARN"
    Value: !GetAtt SendLogsFunction.Arn
  SendLogsFunctionIamRole:
    Description: "Implicit IAM Role created for SolarWinds Observability Logs function"
    Value: !GetAtt SendLogsFunction.Arn
